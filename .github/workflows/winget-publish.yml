name: Publish to Winget

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0, without v prefix)'
        required: true
        type: string

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install wingetcreate
        shell: pwsh
        run: |
          Invoke-WebRequest https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe
          Write-Host "Downloaded wingetcreate"

      - name: Check if manifest exists in winget-pkgs
        id: check-manifest
        shell: pwsh
        run: |
          $response = Invoke-WebRequest -Uri "https://api.github.com/repos/microsoft/winget-pkgs/contents/manifests/o/OpenCLICollective/gmail-readonly" -Method Head -SkipHttpErrorCheck
          if ($response.StatusCode -eq 200) {
            Write-Host "Manifest exists - will use wingetcreate update"
            echo "exists=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Manifest does not exist - will generate and submit new manifests"
            echo "exists=false" >> $env:GITHUB_OUTPUT
          }

      - name: Validate release exists
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $release = gh release view "v${{ inputs.version }}" --json tagName 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Release v${{ inputs.version }} not found. Please ensure the release exists before publishing."
            exit 1
          }
          Write-Host "Found release v${{ inputs.version }}"

      - name: Get checksums from release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download "v${{ inputs.version }}" --pattern "checksums.txt" --dir .

          $checksums = Get-Content checksums.txt
          $x64Hash = ($checksums | Select-String "windows_amd64.zip").Line.Split()[0]
          $arm64Hash = ($checksums | Select-String "windows_arm64.zip").Line.Split()[0]

          Write-Host "x64 SHA256: $x64Hash"
          Write-Host "arm64 SHA256: $arm64Hash"

          echo "X64_HASH=$x64Hash" >> $env:GITHUB_ENV
          echo "ARM64_HASH=$arm64Hash" >> $env:GITHUB_ENV

      - name: Update manifest (existing package)
        if: steps.check-manifest.outputs.exists == 'true'
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"
          $urlX64 = "https://github.com/open-cli-collective/gmail-ro/releases/download/v${version}/gmro_v${version}_windows_amd64.zip"
          $urlArm64 = "https://github.com/open-cli-collective/gmail-ro/releases/download/v${version}/gmro_v${version}_windows_arm64.zip"

          Write-Host "Updating existing manifest to version $version"
          Write-Host "URL x64: $urlX64"
          Write-Host "URL arm64: $urlArm64"
          ./wingetcreate.exe update OpenCLICollective.gmail-readonly --version $version --urls "$urlX64|$urlArm64" --submit --token ${{ secrets.WINGET_GITHUB_TOKEN }}

      - name: Create manifest (new package)
        if: steps.check-manifest.outputs.exists == 'false'
        shell: pwsh
        run: |
          $version = "${{ inputs.version }}"
          $manifestDir = "manifests"
          New-Item -ItemType Directory -Path $manifestDir -Force | Out-Null

          # Update version manifest
          $versionManifest = Get-Content "packaging/winget/OpenCLICollective.gmail-readonly.yaml" -Raw
          $versionManifest = $versionManifest -replace "0\.0\.0", $version
          Set-Content "$manifestDir/OpenCLICollective.gmail-readonly.yaml" $versionManifest -Encoding UTF8

          # Update locale manifest
          $localeManifest = Get-Content "packaging/winget/OpenCLICollective.gmail-readonly.locale.en-US.yaml" -Raw
          $localeManifest = $localeManifest -replace "0\.0\.0", $version
          Set-Content "$manifestDir/OpenCLICollective.gmail-readonly.locale.en-US.yaml" $localeManifest -Encoding UTF8

          # Update installer manifest with version and checksums
          $installerManifest = Get-Content "packaging/winget/OpenCLICollective.gmail-readonly.installer.yaml" -Raw
          $installerManifest = $installerManifest -replace "0\.0\.0", $version
          # Replace x64 checksum (first occurrence)
          $installerManifest = $installerManifest -replace "0{64}", $env:X64_HASH, 1
          # Replace arm64 checksum (second occurrence)
          $installerManifest = $installerManifest -replace "0{64}", $env:ARM64_HASH
          Set-Content "$manifestDir/OpenCLICollective.gmail-readonly.installer.yaml" $installerManifest -Encoding UTF8

          Write-Host "Generated manifests:"
          Get-ChildItem $manifestDir | ForEach-Object { Write-Host "  $_" }

          Write-Host "`nValidating manifests..."
          winget validate --manifest $manifestDir
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Manifest validation failed"
            exit 1
          }
          Write-Host "Validation passed!"

          Write-Host "`nSubmitting new package to Winget..."
          ./wingetcreate.exe submit --token ${{ secrets.WINGET_GITHUB_TOKEN }} $manifestDir
